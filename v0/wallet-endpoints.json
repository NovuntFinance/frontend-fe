{
  "version": "1.0.0",
  "generated": "2025-10-12",
  "description": "Complete wallet and financial operations endpoints documentation for Novunt API",
  "baseUrl": "/api",
  "walletSystem": {
    "architecture": "Two-Wallet System",
    "wallets": {
      "fundedWallet": {
        "description": "Holds deposits and P2P transfers received",
        "sources": ["NowPayments deposits (BEP20/TRC20)", "P2P transfers from other users"],
        "capabilities": ["Staking only"],
        "restrictions": ["Cannot be withdrawn directly"],
        "businessRule": "All deposits and incoming transfers go to funded wallet"
      },
      "earningWallet": {
        "description": "Holds all platform earnings",
        "sources": [
          "Weekly staking returns (Stake Pool, Performance Pool, Premium Pool)",
          "Referral bonuses",
          "Registration bonuses",
          "Completed stake returns"
        ],
        "capabilities": ["Staking", "Withdrawals", "P2P transfers (if funded wallet insufficient)"],
        "restrictions": ["Subject to withdrawal limits and verification"],
        "businessRule": "All earnings go to earning wallet. Withdrawals ONLY from this wallet"
      }
    },
    "fundPriority": {
      "staking": "Can use both fundedWallet + earningWallet",
      "withdrawal": "Only from earningWallet",
      "p2pTransfer": "Deducts from fundedWallet first, then earningWallet if needed"
    }
  },
  "endpoints": {
    "getAllWallets": {
      "method": "GET",
      "path": "/api/wallet/",
      "authentication": true,
      "authorization": {
        "requiredRoles": ["admin", "superAdmin"],
        "middleware": ["authenticateUser", "checkAdmin", "financialOpsLimiter"]
      },
      "description": "Get all user wallets in the system (admin only)",
      "rateLimiting": "Subject to financialOpsLimiter middleware",
      "queryParameters": null,
      "requestBody": null,
      "responses": {
        "200": {
          "description": "Successfully retrieved all wallets",
          "schema": {
            "count": "number",
            "wallets": [
              {
                "user": {
                  "_id": "ObjectId",
                  "email": "string",
                  "username": "string"
                },
                "totalBalance": "number",
                "walletBreakdown": {
                  "fundedWallet": "number",
                  "earningWallet": "number",
                  "total": "number",
                  "canStake": "boolean",
                  "canWithdraw": "boolean"
                },
                "totalDeposited": "number",
                "totalWithdrawn": "number",
                "walletAddress": "string | null",
                "createdAt": "Date"
              }
            ]
          },
          "example": {
            "count": 2,
            "wallets": [
              {
                "user": {
                  "_id": "507f1f77bcf86cd799439011",
                  "email": "user@example.com",
                  "username": "johndoe"
                },
                "totalBalance": 1500.50,
                "walletBreakdown": {
                  "fundedWallet": 1000.00,
                  "earningWallet": 500.50,
                  "total": 1500.50,
                  "canStake": true,
                  "canWithdraw": true
                },
                "totalDeposited": 2000.00,
                "totalWithdrawn": 300.00,
                "walletAddress": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",
                "createdAt": "2025-01-15T10:00:00Z"
              }
            ]
          }
        },
        "500": {
          "description": "Server error",
          "schema": {
            "message": "Failed to fetch wallets."
          }
        }
      }
    },
    "getUserWallet": {
      "method": "GET",
      "path": "/api/wallet/my-wallet",
      "authentication": true,
      "authorization": {
        "requiredRoles": ["user", "admin", "superAdmin"],
        "middleware": ["authenticateUser", "require2FA", "financialOpsLimiter"]
      },
      "description": "Get authenticated user's wallet with complete breakdown",
      "securityNotes": ["Requires 2FA if enabled for user"],
      "queryParameters": null,
      "requestBody": null,
      "responses": {
        "200": {
          "description": "Successfully retrieved user wallet",
          "schema": {
            "success": true,
            "wallet": {
              "fundedWallet": "number",
              "earningWallet": "number",
              "totalBalance": "number",
              "canStake": "boolean",
              "canWithdraw": "boolean",
              "canTransfer": "number",
              "breakdown": {
                "fundedWallet": "number",
                "earningWallet": "number",
                "total": "number",
                "canStake": "boolean",
                "canWithdraw": "boolean"
              },
              "stakingOptions": {
                "availableForStaking": "number",
                "canStakeAll": "boolean",
                "breakdown": {
                  "fromFundedWallet": "number",
                  "fromEarningWallet": "number"
                }
              },
              "transferOptions": {
                "availableForTransfer": "number",
                "canTransferAll": "boolean",
                "breakdown": {
                  "fromFundedWallet": "number",
                  "fromEarningWallet": "number"
                }
              },
              "withdrawalOptions": {
                "availableForWithdrawal": "number",
                "canWithdrawAll": "boolean",
                "breakdown": {
                  "fromEarningWallet": "number"
                }
              },
              "statistics": {
                "totalDeposited": "number",
                "totalWithdrawn": "number",
                "totalTransferReceived": "number",
                "totalTransferSent": "number",
                "totalStaked": "number",
                "totalStakeReturns": "number"
              },
              "walletAddress": "string | null",
              "createdAt": "Date"
            }
          },
          "example": {
            "success": true,
            "wallet": {
              "fundedWallet": 1000.00,
              "earningWallet": 500.50,
              "totalBalance": 1500.50,
              "canStake": true,
              "canWithdraw": true,
              "canTransfer": 1500.50,
              "breakdown": {
                "fundedWallet": 1000.00,
                "earningWallet": 500.50,
                "total": 1500.50,
                "canStake": true,
                "canWithdraw": true
              },
              "stakingOptions": {
                "availableForStaking": 1500.50,
                "canStakeAll": true,
                "breakdown": {
                  "fromFundedWallet": 1000.00,
                  "fromEarningWallet": 500.50
                }
              },
              "transferOptions": {
                "availableForTransfer": 1500.50,
                "canTransferAll": true,
                "breakdown": {
                  "fromFundedWallet": 1000.00,
                  "fromEarningWallet": 500.50
                }
              },
              "withdrawalOptions": {
                "availableForWithdrawal": 500.50,
                "canWithdrawAll": true,
                "breakdown": {
                  "fromEarningWallet": 500.50
                }
              },
              "statistics": {
                "totalDeposited": 2000.00,
                "totalWithdrawn": 300.00,
                "totalTransferReceived": 200.00,
                "totalTransferSent": 150.00,
                "totalStaked": 1500.00,
                "totalStakeReturns": 250.50
              },
              "walletAddress": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",
              "createdAt": "2025-01-15T10:00:00Z"
            }
          }
        },
        "401": {
          "description": "Unauthorized",
          "schema": {
            "message": "Unauthorized"
          }
        },
        "404": {
          "description": "Wallet not found",
          "schema": {
            "message": "Wallet not found"
          }
        },
        "500": {
          "description": "Server error",
          "schema": {
            "message": "Failed to fetch wallet."
          }
        }
      },
      "businessLogic": {
        "twoWalletSystem": "Returns both fundedWallet and earningWallet balances",
        "capabilities": "Shows what actions user can perform based on balance",
        "statistics": "Provides lifetime transaction statistics",
        "breakdown": "Detailed fund allocation for different operations"
      }
    },
    "getUserWalletByUserID": {
      "method": "GET",
      "path": "/api/wallet/:id",
      "authentication": true,
      "authorization": {
        "requiredRoles": ["admin", "superAdmin"],
        "middleware": ["authenticateUser", "checkAdmin", "financialOpsLimiter"]
      },
      "description": "Get specific user's wallet by user ID (admin only)",
      "pathParameters": {
        "id": {
          "type": "string (ObjectId)",
          "required": true,
          "description": "User's MongoDB ObjectId",
          "example": "507f1f77bcf86cd799439011"
        }
      },
      "requestBody": null,
      "responses": {
        "200": {
          "description": "Successfully retrieved user wallet",
          "schema": {
            "success": true,
            "wallet": {
              "user": {
                "_id": "ObjectId",
                "email": "string",
                "username": "string"
              },
              "fundedWallet": "number",
              "earningWallet": "number",
              "totalBalance": "number",
              "walletBreakdown": {
                "fundedWallet": "number",
                "earningWallet": "number",
                "total": "number"
              },
              "totalDeposited": "number",
              "totalWithdrawn": "number",
              "walletAddress": "string | null",
              "createdAt": "Date"
            }
          }
        },
        "400": {
          "description": "Invalid user ID",
          "schema": {
            "message": "Invalid user ID format."
          }
        },
        "404": {
          "description": "Wallet not found",
          "schema": {
            "message": "User wallet not found."
          }
        },
        "500": {
          "description": "Server error",
          "schema": {
            "message": "Failed to fetch user wallet."
          }
        }
      }
    },
    "getWalletInfo": {
      "method": "GET",
      "path": "/api/wallet/info",
      "authentication": true,
      "authorization": {
        "requiredRoles": ["user", "admin", "superAdmin"],
        "middleware": ["authenticateUser", "financialOpsLimiter"]
      },
      "description": "Get comprehensive wallet information with fund routing explanation",
      "queryParameters": null,
      "requestBody": null,
      "responses": {
        "200": {
          "description": "Comprehensive wallet information with fund routing details",
          "schema": {
            "success": true,
            "data": {
              "walletOverview": {
                "totalBalance": "number",
                "fundedWallet": "number",
                "earningWallet": "number",
                "statistics": {
                  "totalDeposited": "number",
                  "totalWithdrawn": "number",
                  "walletAddress": "string | null"
                }
              },
              "fundRouting": {
                "deposits": {
                  "destination": "Funded Wallet",
                  "description": "string",
                  "capabilities": ["string"],
                  "restrictions": ["string"],
                  "balance": "number"
                },
                "p2pTransfers": {
                  "destination": "Funded Wallet",
                  "description": "string",
                  "capabilities": ["string"],
                  "restrictions": ["string"],
                  "note": "string"
                },
                "stakingReturns": {
                  "destination": "Earning Wallet",
                  "description": "string",
                  "capabilities": ["string"],
                  "restrictions": ["string"],
                  "balance": "number"
                },
                "bonuses": {
                  "destination": "Earning Wallet",
                  "description": "string",
                  "capabilities": ["string"],
                  "restrictions": ["string"]
                }
              },
              "availableActions": {
                "staking": {
                  "available": "number",
                  "canStake": "boolean",
                  "fundingSources": "object",
                  "description": "string"
                },
                "withdrawal": {
                  "available": "number",
                  "canWithdraw": "boolean",
                  "fundingSources": "object",
                  "description": "string"
                },
                "transfer": {
                  "available": "number",
                  "canTransfer": "boolean",
                  "fundingSources": "object",
                  "description": "string"
                }
              }
            }
          },
          "example": {
            "success": true,
            "data": {
              "walletOverview": {
                "totalBalance": 1500.50,
                "fundedWallet": 1000.00,
                "earningWallet": 500.50,
                "statistics": {
                  "totalDeposited": 2000.00,
                  "totalWithdrawn": 300.00,
                  "walletAddress": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb"
                }
              },
              "fundRouting": {
                "deposits": {
                  "destination": "Funded Wallet",
                  "description": "All NowPayments deposits (BEP20/TRC20) are credited here",
                  "capabilities": ["Staking"],
                  "restrictions": ["Cannot be withdrawn directly"],
                  "balance": 1000.00
                },
                "p2pTransfers": {
                  "destination": "Funded Wallet",
                  "description": "P2P transfers from other users are credited here",
                  "capabilities": ["Staking"],
                  "restrictions": ["Cannot be withdrawn directly"],
                  "note": "Transfers are deducted from funded wallet first, then earning wallet if needed"
                },
                "stakingReturns": {
                  "destination": "Earning Wallet",
                  "description": "Weekly returns, bonuses, and completed stakes are credited here",
                  "capabilities": ["Staking", "Withdrawals"],
                  "restrictions": ["Subject to withdrawal limits"],
                  "balance": 500.50
                },
                "bonuses": {
                  "destination": "Earning Wallet",
                  "description": "Referral bonuses and other rewards are credited here",
                  "capabilities": ["Staking", "Withdrawals"],
                  "restrictions": ["Subject to withdrawal limits"]
                }
              },
              "availableActions": {
                "staking": {
                  "available": 1500.50,
                  "canStake": true,
                  "fundingSources": {
                    "fromFundedWallet": 1000.00,
                    "fromEarningWallet": 500.50
                  },
                  "description": "Can use funds from both wallets for staking"
                },
                "withdrawal": {
                  "available": 500.50,
                  "canWithdraw": true,
                  "fundingSources": {
                    "fromEarningWallet": 500.50
                  },
                  "description": "Only earnings wallet funds can be withdrawn"
                },
                "transfer": {
                  "available": 1500.50,
                  "canTransfer": true,
                  "fundingSources": {
                    "fromFundedWallet": 1000.00,
                    "fromEarningWallet": 500.50
                  },
                  "description": "Can transfer using both wallets"
                }
              }
            }
          }
        },
        "401": {
          "description": "Unauthorized",
          "schema": {
            "message": "Unauthorized"
          }
        },
        "404": {
          "description": "Wallet not found",
          "schema": {
            "success": false,
            "message": "Wallet not found"
          }
        }
      },
      "businessLogic": {
        "purpose": "Educational endpoint to explain the two-wallet system and fund routing",
        "fundRouting": "Explains where different types of funds are deposited",
        "capabilities": "Shows what actions can be performed with each wallet",
        "restrictions": "Clarifies withdrawal and usage limitations"
      }
    },
    "getTransferPreview": {
      "method": "POST",
      "path": "/api/wallet/transfer/preview",
      "authentication": true,
      "authorization": {
        "requiredRoles": ["user", "admin", "superAdmin"],
        "middleware": ["authenticateUser", "require2FA", "financialOpsLimiter"]
      },
      "description": "Preview P2P transfer with fees calculation. Supports specific amount or 'ALL' transfer",
      "securityNotes": ["Requires 2FA if enabled", "Rate limited for security"],
      "requestBody": {
        "required": true,
        "contentType": "application/json",
        "schema": {
          "recipientId": {
            "type": "string (ObjectId)",
            "required": true,
            "description": "Recipient user's ID",
            "example": "507f1f77bcf86cd799439012"
          },
          "amount": {
            "type": "number",
            "required": false,
            "description": "Transfer amount in USDT. Omit for 'ALL' transfer preview",
            "example": 100.50,
            "validation": "Must be >= min_transfer_amount and <= max_transfer_amount"
          }
        }
      },
      "systemSettings": {
        "transfer_fee_percentage": {
          "type": "number",
          "default": 0,
          "description": "Percentage fee on transfers (e.g., 2 for 2%)"
        },
        "transfer_fee_fixed": {
          "type": "number",
          "default": 0,
          "description": "Fixed fee per transfer in USDT"
        },
        "min_transfer_amount": {
          "type": "number",
          "default": 1,
          "description": "Minimum transfer amount in USDT"
        },
        "max_transfer_amount": {
          "type": "number",
          "default": 999999,
          "description": "Maximum transfer amount in USDT (0 for unlimited)"
        },
        "transfer_enabled": {
          "type": "boolean",
          "default": true,
          "description": "Enable/disable P2P transfers globally"
        }
      },
      "responses": {
        "200": {
          "description": "Transfer preview generated successfully",
          "schemas": [
            {
              "case": "Specific amount preview",
              "schema": {
                "success": true,
                "preview": {
                  "amount": "number",
                  "recipient": {
                    "id": "ObjectId",
                    "username": "string",
                    "firstName": "string"
                  },
                  "fees": {
                    "percentage": "number",
                    "fixed": "number",
                    "total": "number",
                    "breakdown": "string (e.g., '2% + 1 USDT')"
                  },
                  "totalDeduction": "number",
                  "recipientReceives": "number",
                  "senderBalance": {
                    "current": "number",
                    "afterTransfer": "number"
                  }
                }
              },
              "example": {
                "success": true,
                "preview": {
                  "amount": 100.00,
                  "recipient": {
                    "id": "507f1f77bcf86cd799439012",
                    "username": "janedoe",
                    "firstName": "Jane"
                  },
                  "fees": {
                    "percentage": 2.00,
                    "fixed": 1.00,
                    "total": 3.00,
                    "breakdown": "2% + 1 USDT"
                  },
                  "totalDeduction": 103.00,
                  "recipientReceives": 100.00,
                  "senderBalance": {
                    "current": 1500.50,
                    "afterTransfer": 1397.50
                  }
                }
              }
            },
            {
              "case": "ALL transfer preview (no amount specified)",
              "schema": {
                "success": true,
                "preview": {
                  "isAllTransfer": true,
                  "amount": "number (calculated maximum transferable)",
                  "recipient": {
                    "id": "ObjectId",
                    "username": "string",
                    "firstName": "string"
                  },
                  "fees": {
                    "percentage": "number",
                    "fixed": "number",
                    "total": "number",
                    "breakdown": "string"
                  },
                  "totalDeduction": "number",
                  "recipientReceives": "number",
                  "senderBalance": {
                    "current": "number",
                    "afterTransfer": "number (should be ~0)"
                  },
                  "maxPossible": {
                    "amount": "number",
                    "willUseAllFunds": "boolean"
                  }
                }
              },
              "example": {
                "success": true,
                "preview": {
                  "isAllTransfer": true,
                  "amount": 1470.10,
                  "recipient": {
                    "id": "507f1f77bcf86cd799439012",
                    "username": "janedoe",
                    "firstName": "Jane"
                  },
                  "fees": {
                    "percentage": 29.40,
                    "fixed": 1.00,
                    "total": 30.40,
                    "breakdown": "2% + 1 USDT"
                  },
                  "totalDeduction": 1500.50,
                  "recipientReceives": 1470.10,
                  "senderBalance": {
                    "current": 1500.50,
                    "afterTransfer": 0.00
                  },
                  "maxPossible": {
                    "amount": 1470.10,
                    "willUseAllFunds": true
                  }
                }
              }
            }
          ]
        },
        "400": {
          "description": "Validation error or insufficient funds",
          "possibleErrors": [
            {
              "code": "TRANSFER_DISABLED",
              "message": "P2P transfers are temporarily disabled"
            },
            {
              "code": "MIN_AMOUNT",
              "message": "Minimum transfer amount is X USDT"
            },
            {
              "code": "MAX_AMOUNT",
              "message": "Maximum transfer amount is X USDT"
            },
            {
              "code": "INSUFFICIENT_BALANCE",
              "message": "Insufficient balance. You need X USDT but only have Y USDT available in transfer wallet"
            },
            {
              "code": "BELOW_MIN_AFTER_FEES",
              "message": "Insufficient balance to meet minimum transfer amount of X USDT after fees"
            }
          ]
        },
        "404": {
          "description": "User not found",
          "schema": {
            "success": false,
            "message": "Sender or recipient not found"
          }
        }
      },
      "businessLogic": {
        "feeCalculation": "totalFee = (amount * transfer_fee_percentage / 100) + transfer_fee_fixed",
        "totalDeduction": "amount + totalFee",
        "allTransferCalculation": "Reverse calculates maximum amount: amount = (availableBalance - fixedFee) / (1 + percentage/100)",
        "fundSource": "Deducts from fundedWallet first, then earningWallet if needed"
      }
    },
    "transferAll": {
      "method": "POST",
      "path": "/api/wallet/transfer/all",
      "authentication": true,
      "authorization": {
        "requiredRoles": ["user", "admin", "superAdmin"],
        "middleware": ["authenticateUser", "require2FA", "financialOpsLimiter"]
      },
      "description": "Transfer ALL available funds to another user. Automatically calculates maximum transferable amount after fees.",
      "securityNotes": [
        "Requires 2FA if enabled",
        "Rate limited",
        "Double-spending protection",
        "Behavioral monitoring for suspicious patterns"
      ],
      "requestBody": {
        "required": true,
        "contentType": "application/json",
        "schema": {
          "recipientId": {
            "type": "string (ObjectId)",
            "required": true,
            "description": "Recipient user's ID",
            "example": "507f1f77bcf86cd799439012"
          }
        }
      },
      "responses": {
        "200": {
          "description": "Transfer completed successfully",
          "schema": {
            "success": true,
            "message": "Transfer completed successfully",
            "data": {
              "transaction": {
                "_id": "ObjectId",
                "txId": "string (UUID)",
                "amount": "number",
                "fee": "number",
                "netAmount": "number",
                "recipient": {
                  "id": "ObjectId",
                  "username": "string"
                },
                "timestamp": "Date"
              }
            }
          }
        },
        "400": {
          "description": "Validation error or insufficient funds",
          "possibleErrors": [
            {
              "message": "No funds available in transfer wallet"
            },
            {
              "message": "Insufficient balance to cover transfer fees"
            }
          ]
        },
        "404": {
          "description": "Wallet not found",
          "schema": {
            "success": false,
            "message": "Sender wallet not found"
          }
        },
        "500": {
          "description": "Server error",
          "schema": {
            "success": false,
            "message": "Failed to transfer all funds",
            "error": "Error details (in development mode)"
          }
        }
      },
      "businessLogic": {
        "calculation": "Automatically calculates maximum transferable amount using reverse fee calculation",
        "delegation": "Internally calls transferUSDT controller with calculated amount",
        "feeHandling": "Ensures all available funds are used, accounting for fees"
      }
    },
    "getStakingPreview": {
      "method": "POST",
      "path": "/api/wallet/staking/preview",
      "authentication": true,
      "authorization": {
        "requiredRoles": ["user", "admin", "superAdmin"],
        "middleware": ["authenticateUser", "require2FA", "financialOpsLimiter"]
      },
      "description": "Preview staking operation with fund allocation breakdown. Supports specific amount or 'ALL' staking",
      "securityNotes": ["Requires 2FA if enabled", "Rate limited"],
      "requestBody": {
        "required": false,
        "contentType": "application/json",
        "schema": {
          "amount": {
            "type": "number",
            "required": false,
            "description": "Stake amount in USDT. Omit for 'ALL' staking preview",
            "example": 500.00,
            "validation": "Must be >= min_stake_amount (default: 20 USDT)"
          }
        }
      },
      "systemSettings": {
        "min_stake_amount": {
          "type": "number",
          "default": 20,
          "description": "Minimum stake amount in USDT"
        },
        "max_stake_amount": {
          "type": "number",
          "default": 10000000,
          "description": "Maximum stake amount in USDT"
        },
        "staking_enabled": {
          "type": "boolean",
          "default": true,
          "description": "Enable/disable staking globally"
        }
      },
      "responses": {
        "200": {
          "description": "Staking preview generated successfully",
          "schemas": [
            {
              "case": "Specific amount preview",
              "schema": {
                "success": true,
                "preview": {
                  "amount": "number",
                  "allocation": {
                    "fromMain": "number (deprecated - same as fromFundedWallet)",
                    "fromReferral": "number (deprecated)",
                    "fromStaking": "number (deprecated)",
                    "fromTransfer": "number (deprecated)"
                  },
                  "fundingSources": ["string array describing allocation"],
                  "balanceAfterStaking": {
                    "main": "number",
                    "referral": "number",
                    "staking": "number",
                    "transfer": "number"
                  }
                }
              },
              "example": {
                "success": true,
                "preview": {
                  "amount": 500.00,
                  "allocation": {
                    "fromMain": 500.00,
                    "fromReferral": 0,
                    "fromStaking": 0,
                    "fromTransfer": 0
                  },
                  "fundingSources": [
                    "$500 from Main Wallet"
                  ],
                  "balanceAfterStaking": {
                    "main": 500.00,
                    "referral": 0,
                    "staking": 0,
                    "transfer": 0
                  }
                }
              },
              "note": "The old wallet fields (main, referral, staking, transfer) are deprecated. Use fundedWallet and earningWallet instead."
            },
            {
              "case": "ALL staking preview (no amount specified)",
              "schema": {
                "success": true,
                "preview": {
                  "isAllStaking": true,
                  "amount": "number (all available balance)",
                  "allocation": {
                    "fromMain": "number",
                    "fromReferral": "number",
                    "fromStaking": "number",
                    "fromTransfer": "number"
                  },
                  "fundingSources": ["string array"],
                  "balanceAfterStaking": {
                    "main": 0,
                    "referral": 0,
                    "staking": 0,
                    "transfer": 0
                  },
                  "willUseAllFunds": true,
                  "maxPossible": "boolean"
                }
              },
              "example": {
                "success": true,
                "preview": {
                  "isAllStaking": true,
                  "amount": 1500.50,
                  "allocation": {
                    "fromMain": 1000.00,
                    "fromReferral": 0,
                    "fromStaking": 0,
                    "fromTransfer": 500.50
                  },
                  "fundingSources": [
                    "$1000 from Main Wallet",
                    "$500.50 from Transfer Wallet"
                  ],
                  "balanceAfterStaking": {
                    "main": 0,
                    "referral": 0,
                    "staking": 0,
                    "transfer": 0
                  },
                  "willUseAllFunds": true,
                  "maxPossible": true
                }
              }
            }
          ]
        },
        "400": {
          "description": "Validation error",
          "possibleErrors": [
            {
              "message": "Staking is temporarily disabled"
            },
            {
              "message": "Minimum stake amount is X USDT"
            },
            {
              "message": "Maximum stake amount is X USDT"
            },
            {
              "message": "Insufficient balance. You need X USDT but only have Y USDT available for staking"
            },
            {
              "message": "Insufficient balance to meet minimum stake amount of X USDT"
            }
          ]
        },
        "404": {
          "description": "Wallet not found",
          "schema": {
            "success": false,
            "message": "User wallet not found"
          }
        },
        "500": {
          "description": "Server error",
          "schema": {
            "success": false,
            "message": "Failed to generate staking preview",
            "error": "Error details (in development mode)"
          }
        }
      },
      "businessLogic": {
        "fundAllocation": "Shows which wallets will be used and in what amounts",
        "allStaking": "When no amount specified, stakes all available balance",
        "maxStakeLimit": "Respects max_stake_amount system setting",
        "noFees": "Staking has no fees, unlike transfers or withdrawals"
      }
    }
  },
  "transactionEndpoints": {
    "note": "Deposit, withdrawal, and transfer execution endpoints are documented separately in transaction-referral-endpoints.json. This file covers wallet query and preview operations only."
  },
  "businessRules": {
    "twoWalletSystem": {
      "fundedWallet": {
        "sources": ["Deposits via NowPayments", "P2P transfers received"],
        "uses": ["Staking only"],
        "cannotWithdraw": true,
        "explanation": "Ensures deposited funds are invested in the platform"
      },
      "earningWallet": {
        "sources": [
          "Weekly stake returns",
          "Referral bonuses",
          "Registration bonuses",
          "Completed stakes"
        ],
        "uses": ["Staking", "Withdrawals", "P2P transfers (if funded insufficient)"],
        "withdrawalOnly": "Only wallet from which withdrawals are allowed"
      }
    },
    "fundPriority": {
      "staking": "Can use both wallets (fundedWallet + earningWallet)",
      "withdrawal": "Only from earningWallet",
      "p2pTransfer": "Deducts from fundedWallet first, then earningWallet if needed"
    },
    "fees": {
      "transfers": "Configurable: percentage fee + fixed fee",
      "staking": "No fees",
      "withdrawals": "Documented in withdrawal endpoints"
    },
    "limits": {
      "minimumTransfer": "Configurable via min_transfer_amount setting (default: 1 USDT)",
      "maximumTransfer": "Configurable via max_transfer_amount setting (default: 999999 USDT)",
      "minimumStake": "Configurable via min_stake_amount setting (default: 20 USDT)",
      "maximumStake": "Configurable via max_stake_amount setting (default: 10,000,000 USDT)"
    },
    "security": {
      "rateLimiting": "All financial operations are rate-limited via financialOpsLimiter",
      "2faRequired": "Personal wallet operations require 2FA if enabled",
      "doubleSpending": "Transfer and withdrawal operations have double-spending protection",
      "behavioralMonitoring": "Suspicious patterns trigger additional verification or blocking"
    }
  },
  "deprecationNotes": {
    "oldWalletFields": {
      "deprecated": ["main", "referral", "staking", "transfer"],
      "replacedBy": ["fundedWallet", "earningWallet"],
      "transitionPeriod": "Old fields still present in some responses for backward compatibility",
      "futureAction": "Frontend should use fundedWallet and earningWallet exclusively"
    }
  },
  "frontendIntegrationGuide": {
    "walletDisplay": {
      "primaryMetrics": [
        "fundedWallet - Display as 'Deposit Wallet' or 'Funded Wallet'",
        "earningWallet - Display as 'Earnings Wallet' or 'Withdrawable Balance'",
        "totalBalance - Display as 'Total Balance'"
      ],
      "capabilities": [
        "Show 'Can Stake' badge if canStake is true",
        "Show 'Can Withdraw' badge if canWithdraw is true",
        "Display available amounts for each operation"
      ],
      "statistics": [
        "Show lifetime totals: deposited, withdrawn, staked, earned",
        "Display transfer history totals"
      ]
    },
    "transferFlow": {
      "steps": [
        "1. User searches for recipient (searchUsersByUsername)",
        "2. User enters amount or selects 'Send All'",
        "3. Call getTransferPreview to show fees and net amount",
        "4. Display preview with confirmation prompt",
        "5. User confirms → Call transferUSDT or transferAll",
        "6. Show success message with transaction details"
      ],
      "preview": "Always show preview before executing transfer",
      "allTransferButton": "Provide 'Send All' button that calls transferAll endpoint"
    },
    "stakingFlow": {
      "steps": [
        "1. User enters stake amount or selects 'Stake All'",
        "2. Call getStakingPreview to show fund allocation",
        "3. Display which wallets will be used",
        "4. User confirms → Call stake endpoint (transaction-endpoints)",
        "5. Show success and new stake details"
      ],
      "preview": "Show fund allocation breakdown in preview",
      "minimumStake": "Enforce 20 USDT minimum on frontend"
    },
    "withdrawalFlow": {
      "steps": [
        "1. User enters withdrawal amount",
        "2. Check earningWallet balance (only source)",
        "3. Show fees and net amount",
        "4. User confirms → Call createWithdrawalRequest",
        "5. Show pending status (admin approval required)"
      ],
      "restrictions": "Only allow withdrawal from earningWallet balance",
      "approval": "Inform user that withdrawals require admin approval"
    },
    "errorHandling": {
      "insufficientFunds": "Show clear message indicating which wallet lacks funds",
      "belowMinimum": "Display minimum amount required",
      "aboveMaximum": "Display maximum amount allowed",
      "disabledFeature": "Show 'Temporarily unavailable' message",
      "rateLimitExceeded": "Ask user to wait before retrying"
    },
    "realTimeUpdates": {
      "balanceRefresh": "Refresh wallet after any transaction",
      "websockets": "Consider using WebSocket for real-time balance updates",
      "polling": "Alternative: Poll getUserWallet every 30-60 seconds on wallet page"
    }
  },
  "withdrawalEndpoints": {
    "baseUrl": "/api/withdrawal",
    "description": "Withdrawal request and management endpoints",
    "endpoints": [
      {
        "method": "GET",
        "path": "/api/withdrawal/limits",
        "description": "Get user's withdrawal limits and current usage",
        "authentication": "Required (JWT or Session)",
        "authorization": "User (own data)",
        "requestHeaders": {
          "Authorization": "Bearer <token>",
          "Content-Type": "application/json"
        },
        "successResponse": {
          "code": 200,
          "body": {
            "success": true,
            "message": "Withdrawal limits retrieved successfully",
            "data": {
              "earningWalletBalance": 1250.75,
              "minWithdrawalAmount": 10,
              "maxWithdrawalAmount": 10000,
              "withdrawalFeePercentage": 5,
              "dailyWithdrawalsRemaining": 2,
              "maxWithdrawalsPerDay": 2,
              "limitsResetAt": "2024-10-13T00:00:00.000Z",
              "todayWithdrawals": [
                {
                  "amount": 500,
                  "status": "pending",
                  "requestedAt": "2024-10-12T08:30:00.000Z"
                }
              ],
              "canWithdraw": true,
              "restrictions": {
                "sourceWallet": "earningWallet only",
                "requiresAdminApproval": true,
                "requires2FA": true
              }
            }
          }
        },
        "errorResponses": [
          { "code": 401, "description": "Unauthorized - Invalid or missing token" },
          { "code": 500, "description": "Internal server error" }
        ],
        "businessLogic": {
          "withdrawalSource": "Only from earningWallet (fundedWallet cannot be withdrawn)",
          "dailyLimits": "Max 2 withdrawals per day (UTC timezone)",
          "feeCalculation": "5% fee deducted from withdrawal amount",
          "adminApproval": "All withdrawals require admin approval",
          "2FARequired": "User must have 2FA enabled and verified"
        }
      },
      {
        "method": "POST",
        "path": "/api/withdrawal/withdraw",
        "description": "Create a withdrawal request (requires 2FA verification)",
        "authentication": "Required (JWT or Session)",
        "authorization": "User (own data)",
        "middleware": ["authenticateUser", "validateWithdrawalAmount", "financialSecurityCheck", "require2FA"],
        "requestHeaders": {
          "Authorization": "Bearer <token>",
          "Content-Type": "application/json"
        },
        "requestBody": {
          "amount": 500,
          "walletAddress": "0x1234567890abcdef1234567890abcdef12345678",
          "network": "BEP20"
        },
        "requestValidation": {
          "amount": {
            "required": true,
            "type": "number",
            "min": 10,
            "max": 10000,
            "description": "Withdrawal amount in USD"
          },
          "walletAddress": {
            "required": true,
            "type": "string",
            "validation": "Must be valid crypto wallet address",
            "description": "Destination wallet address (BEP20 or TRC20)"
          },
          "network": {
            "required": true,
            "type": "string",
            "enum": ["BEP20", "TRC20"],
            "description": "Blockchain network for withdrawal"
          }
        },
        "successResponse": {
          "code": 201,
          "body": {
            "success": true,
            "message": "Withdrawal request created successfully. Pending admin approval.",
            "data": {
              "withdrawalRequest": {
                "_id": "withdrawal_request_id",
                "user": "user_id",
                "amount": 500,
                "fee": 25,
                "netAmount": 475,
                "walletAddress": "0x1234567890abcdef1234567890abcdef12345678",
                "network": "BEP20",
                "status": "pending",
                "requestedAt": "2024-10-12T10:00:00.000Z",
                "estimatedProcessingTime": "1-3 business days"
              },
              "updatedBalance": {
                "earningWallet": 750.75,
                "fundedWallet": 500
              }
            }
          }
        },
        "errorResponses": [
          {
            "code": 400,
            "description": "Invalid request data",
            "examples": [
              "Amount below minimum (10 USD)",
              "Amount above maximum (10000 USD)",
              "Invalid wallet address format",
              "Invalid network selection"
            ]
          },
          {
            "code": 403,
            "description": "Forbidden",
            "examples": [
              "Insufficient funds in earningWallet",
              "Daily withdrawal limit exceeded (2 per day)",
              "2FA not enabled or not verified",
              "Account security check failed",
              "Withdrawals temporarily disabled"
            ]
          },
          {
            "code": 409,
            "description": "Conflict - Duplicate withdrawal request",
            "message": "A withdrawal request is already being processed"
          },
          {
            "code": 429,
            "description": "Too many withdrawal attempts",
            "message": "Please wait before trying again"
          },
          {
            "code": 500,
            "description": "Internal server error"
          }
        ],
        "securityMeasures": {
          "doubleSpendingPrevention": "Transaction locks prevent duplicate withdrawals",
          "behavioralMonitoring": "Monitors for suspicious withdrawal patterns",
          "riskScoring": "High-risk withdrawals (score >= 80) are auto-blocked",
          "rateLimiting": "Financial operations rate limiter applied",
          "2FARequired": "Mandatory 2FA verification before processing"
        },
        "processingFlow": {
          "step1": "Validate withdrawal amount and wallet address",
          "step2": "Check earningWallet balance (deduct amount + fee)",
          "step3": "Create withdrawal request with 'pending' status",
          "step4": "Deduct funds from earningWallet immediately",
          "step5": "Send email notification to user and admin",
          "step6": "Admin reviews and approves/rejects",
          "step7": "If approved: Process NowPayments withdrawal",
          "step8": "If rejected: Refund to earningWallet"
        }
      },
      {
        "method": "POST",
        "path": "/api/withdrawal/mock",
        "description": "Mock withdrawal for testing (development only)",
        "authentication": "Not required (test endpoint)",
        "note": "This endpoint should be disabled in production",
        "requestBody": {
          "amount": 100,
          "walletAddress": "test_wallet_address"
        },
        "successResponse": {
          "code": 200,
          "body": {
            "success": true,
            "message": "Mock withdrawal successful",
            "data": {
              "txId": "mock_tx_id",
              "amount": 100
            }
          }
        }
      }
    ],
    "withdrawalStatuses": {
      "pending": "Withdrawal request created, waiting for admin approval",
      "approved": "Admin approved, processing blockchain transaction",
      "confirmed": "Withdrawal successfully sent to user wallet",
      "rejected": "Admin rejected, funds refunded to earningWallet",
      "failed": "Blockchain transaction failed, funds refunded"
    }
  },
  "transferEndpoints": {
    "baseUrl": "/api/transfer",
    "description": "P2P transfer endpoints for sending USDT between users",
    "endpoints": [
      {
        "method": "POST",
        "path": "/api/transfer/",
        "description": "Transfer USDT to another user (FREE - no fees)",
        "authentication": "Required (JWT or Session)",
        "authorization": "User",
        "middleware": ["authenticateUser", "require2FA"],
        "requestHeaders": {
          "Authorization": "Bearer <token>",
          "Content-Type": "application/json"
        },
        "requestBody": {
          "recipientId": "recipient_user_id",
          "amount": 50,
          "memo": "Payment for services (optional)"
        },
        "requestValidation": {
          "recipientId": {
            "required": true,
            "type": "string",
            "description": "ID of the recipient user (24 hex characters)"
          },
          "amount": {
            "required": true,
            "type": "number",
            "min": 1,
            "description": "Transfer amount in USD (minimum: 1 USDT)"
          },
          "memo": {
            "required": false,
            "type": "string",
            "maxLength": 200,
            "description": "Optional note for the transfer"
          }
        },
        "successResponse": {
          "code": 200,
          "body": {
            "success": true,
            "message": "Transfer successful",
            "data": {
              "transaction": {
                "_id": "transaction_id",
                "fromUser": "sender_id",
                "toUser": "recipient_id",
                "amount": 50,
                "type": "transfer",
                "status": "confirmed",
                "reference": "TXN-2024-123456",
                "memo": "Payment for services",
                "timestamp": "2024-10-12T10:30:00.000Z"
              },
              "senderWallet": {
                "earningWallet": 700.75,
                "fundedWallet": 500
              },
              "recipientWallet": {
                "earningWallet": 0,
                "fundedWallet": 550
              }
            }
          }
        },
        "errorResponses": [
          {
            "code": 400,
            "description": "Invalid request data",
            "examples": [
              "Recipient ID and amount are required",
              "Amount must be greater than 0",
              "You cannot transfer to yourself",
              "Amount below minimum (1 USDT)",
              "Amount above maximum (if set)"
            ]
          },
          {
            "code": 403,
            "description": "Insufficient funds",
            "message": "Insufficient balance in earningWallet",
            "details": "Transfer deducts from earningWallet first, then fundedWallet if needed"
          },
          {
            "code": 404,
            "description": "Recipient not found",
            "message": "Recipient user does not exist"
          },
          {
            "code": 409,
            "description": "Duplicate transfer detected",
            "message": "A similar transfer is already being processed"
          },
          {
            "code": 429,
            "description": "Suspicious activity detected",
            "message": "Transfer temporarily blocked due to suspicious activity"
          },
          {
            "code": 503,
            "description": "Service unavailable",
            "message": "P2P transfers are temporarily disabled"
          }
        ],
        "businessLogic": {
          "transferSource": "Deducts from earningWallet first, then fundedWallet if needed",
          "transferDestination": "Goes to recipient's fundedWallet (can only stake, not withdraw)",
          "fees": "FREE - No transfer fees",
          "2FARequired": "Sender must have 2FA enabled",
          "selfTransfer": "Users cannot transfer to themselves",
          "minimumAmount": "1 USDT (configurable via system settings)",
          "maximumAmount": "Configurable via system settings (default: unlimited)"
        },
        "securityMeasures": {
          "doubleSpendingPrevention": "Transaction locks prevent duplicate transfers",
          "behavioralMonitoring": "Monitors for suspicious transfer patterns",
          "riskScoring": "High-risk transfers (score >= 80) are auto-blocked",
          "rateLimiting": "Prevents rapid-fire transfer attempts",
          "transactionSession": "Uses MongoDB session for atomic operations"
        },
        "fundRouting": {
          "sender": {
            "deductionOrder": "1. earningWallet → 2. fundedWallet (if earningWallet insufficient)",
            "example": "If earningWallet: 30, fundedWallet: 100, transfer 50 → deduct 30 from earning, 20 from funded"
          },
          "recipient": {
            "destination": "fundedWallet (can only stake, cannot withdraw)",
            "notification": "Recipient gets notification of incoming transfer"
          }
        }
      },
      {
        "method": "GET",
        "path": "/api/transfer/history",
        "description": "Get user's transfer history (sent and received)",
        "authentication": "Required (JWT or Session)",
        "authorization": "User (own data)",
        "requestHeaders": {
          "Authorization": "Bearer <token>",
          "Content-Type": "application/json"
        },
        "queryParameters": {
          "page": "Page number (default: 1)",
          "limit": "Items per page (default: 20, max: 100)",
          "type": "Filter by 'sent' or 'received'",
          "startDate": "Filter transfers after this date (ISO format)",
          "endDate": "Filter transfers before this date (ISO format)"
        },
        "successResponse": {
          "code": 200,
          "body": {
            "success": true,
            "message": "Transfer history retrieved successfully",
            "data": {
              "transfers": [
                {
                  "_id": "transaction_id",
                  "type": "transfer",
                  "direction": "sent",
                  "amount": 50,
                  "otherParty": {
                    "userId": "recipient_id",
                    "username": "recipient_username"
                  },
                  "memo": "Payment for services",
                  "status": "confirmed",
                  "timestamp": "2024-10-12T10:30:00.000Z"
                },
                {
                  "_id": "transaction_id_2",
                  "type": "transfer",
                  "direction": "received",
                  "amount": 100,
                  "otherParty": {
                    "userId": "sender_id",
                    "username": "sender_username"
                  },
                  "memo": "Gift",
                  "status": "confirmed",
                  "timestamp": "2024-10-11T15:20:00.000Z"
                }
              ],
              "summary": {
                "totalSent": 250,
                "totalReceived": 400,
                "netTransfers": 150,
                "transferCount": 12
              },
              "pagination": {
                "currentPage": 1,
                "totalPages": 2,
                "totalTransfers": 12,
                "limit": 20
              }
            }
          }
        },
        "errorResponses": [
          { "code": 401, "description": "Unauthorized - Invalid or missing token" },
          { "code": 500, "description": "Internal server error" }
        ]
      }
    ],
    "transferStatuses": {
      "confirmed": "Transfer successfully completed",
      "pending": "Transfer in progress (rare - usually instant)",
      "failed": "Transfer failed (funds refunded)"
    }
  }
}

